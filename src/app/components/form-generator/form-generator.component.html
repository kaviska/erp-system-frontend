<div class="card" *ngIf="config">
  <div class="card-body">
    <!-- Loading State -->
    <div *ngIf="loading" class="text-center p-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading form...</p>
    </div>

    <!-- Form Content -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()" *ngIf="form && !loading">
      <div class="row ">
        <!-- Dynamic Fields Generation -->
        <div 
          *ngFor="let field of config.fields" 
          [ngClass]="getColumnClass(field)">
          
          <div class="mb-7" appHasPermission="{{field.permission}}">
            <!-- Field Label (for non-checkbox fields) -->
             <!-- <span>{{field.permission}}</span> -->
            <label 
              *ngIf="field.type !== 'checkbox'" 
              class="form-label">
              {{ field.label }}
              <span *ngIf="field.validation?.required" class="text-danger">*</span>
            </label>

            <!-- Text, Email, Password, Number Inputs -->
            <input 
              *ngIf="['text', 'email', 'password', 'number'].includes(field.type)"
              [type]="field.type"
              [formControlName]="field.name"
              [placeholder]="field.placeholder || ''"
              [ngClass]="getFieldClass(field)"
              [class.is-invalid]="isFieldInvalid(field.name)"
              [readonly]="field.readonly || false" />

            <!-- Date and DateTime Inputs -->
            <input 
              *ngIf="['date', 'datetime-local'].includes(field.type)"
              [type]="field.type"
              [formControlName]="field.name"
              [placeholder]="field.placeholder || ''"
              [ngClass]="getFieldClass(field)"
              [class.is-invalid]="isFieldInvalid(field.name)"
              [readonly]="field.readonly || false" />

            <!-- Select Input with Select2 Support -->
            <select 
              *ngIf="field.type === 'select'"
              [formControlName]="field.name"
              [ngClass]="getFieldClass(field)"
              [class.is-invalid]="isFieldInvalid(field.name)"
              [multiple]="field.multiple || false"
              [attr.data-control]="field.searchable !== false ? 'select2' : null"
              [attr.data-placeholder]="field.placeholder || 'Select an option'"
              [attr.data-allow-clear]="field.allowClear ? 'true' : null"
              [attr.data-close-on-select]="field.closeOnSelect !== false ? 'true' : 'false'"
              [attr.data-minimum-results-for-search]="field.searchable === false ? 'Infinity' : null">
              
              <option value="" *ngIf="!field.multiple">
                {{ field.placeholder || 'Select an option' }}
              </option>
              <option 
                *ngFor="let option of field.options" 
                [value]="option.value">
                {{ option.label }}
              </option>
            </select>

            <!-- Textarea -->
            <textarea 
              *ngIf="field.type === 'textarea'"
              [formControlName]="field.name"
              [placeholder]="field.placeholder || ''"
              [ngClass]="getFieldClass(field)"
              [class.is-invalid]="isFieldInvalid(field.name)"
              [rows]="field.rows || 4"
              [readonly]="field.readonly || false">
            </textarea>

            <!-- Checkbox -->
            <div *ngIf="field.type === 'checkbox'" class="form-check">
              <input 
                type="checkbox"
                [formControlName]="field.name"
                [ngClass]="getFieldClass(field)"
                [id]="field.name + '_checkbox'"
                [class.is-invalid]="isFieldInvalid(field.name)" />
              <label 
                class="form-check-label" 
                [for]="field.name + '_checkbox'">
                {{ field.label }}
                <span *ngIf="field.validation?.required" class="text-danger">*</span>
              </label>
            </div>

            <!-- Radio Buttons -->
            <div *ngIf="field.type === 'radio'" class="form-group">
              <div 
                *ngFor="let option of field.options; let i = index" 
                class="form-check">
                <input 
                  type="radio"
                  [formControlName]="field.name"
                  [value]="option.value"
                  [id]="field.name + '_radio_' + i"
                  class="form-check-input"
                  [class.is-invalid]="isFieldInvalid(field.name)" />
                <label 
                  class="form-check-label" 
                  [for]="field.name + '_radio_' + i">
                  {{ option.label }}
                </label>
              </div>
            </div>

            <!-- Checkbox Groups with Headers -->
            <div *ngIf="field.type === 'checkbox-group'" class="form-group">
              <div *ngFor="let group of field.groups; let groupIndex = index" class="checkbox-group-container">
                <!-- Group Header -->
                <div class="checkbox-group-header">
                  <i class="fas fa-shield-alt me-2"></i>
                  {{ group.title }}
                </div>
                
               
                
                <!-- Group Checkboxes -->
                <div class="row">
                   <!-- Select All Checkbox (only show if group has more than one option) -->
                <div *ngIf="group.options && group.options.length > 1" class="mb-3">
                  <div class="form-check select-all-checkbox">
                    <input 
                      type="checkbox"
                      [id]="field.name + '_group_' + groupIndex + '_select_all'"
                      class="form-check-input mx-1"
                      [checked]="isGroupSelectAllChecked(field.name, group.options)"
                      (change)="onGroupSelectAllChange(field.name, group.options, $any($event.target).checked)"
                      [class.is-invalid]="isFieldInvalid(field.name)" />
                    <label 
                      class="form-check-label" 
                      [for]="field.name + '_group_' + groupIndex + '_select_all'">
                     
                      Select All
                    </label>
                  </div>
                </div>
                  <div 
                    *ngFor="let option of group.options; let i = index"
                    class="col-12 col-md-6 col-lg-4 checkbox-group-item">
                    <div class="form-check">
                      <input 
                        type="checkbox"
                        [id]="field.name + '_group_' + groupIndex + '_checkbox_' + i"
                        class="form-check-input  mx-1"
                        [checked]="isCheckboxChecked(field.name, option.value)"
                        (change)="onCheckboxGroupChange(field.name, option.value, $any($event.target).checked)"
                        [class.is-invalid]="isFieldInvalid(field.name)" />
                      <label 
                        class="form-check-label" 
                        [for]="field.name + '_group_' + groupIndex + '_checkbox_' + i">
                        {{ option.label }}
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Error Message -->
            <div 
              *ngIf="shouldShowError(field.name)" 
              class="invalid-feedback d-block">
              <i class="fas fa-exclamation-circle me-2"></i>
              {{ getFieldError(field.name) }}
            </div>

            <!-- Field Help Text (if needed) -->
            <div 
              *ngIf="field.placeholder && ['textarea', 'select'].includes(field.type)" 
              class="form-text text-muted">
              {{ field.placeholder }}
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="row" *ngIf="config.submitButtonText || config.showResetButton">
        <div class="col-12">
          <div class="separator separator-dashed my-5"></div>
          <div class="d-flex justify-content-end gap-3">
            <!-- Reset Button -->
            <button 
              *ngIf="config.showResetButton"
              type="button" 
              class="btn btn-light btn-active-light-primary"
              (click)="onReset()">
              <i class="fas fa-undo me-2"></i>
              {{ config.resetButtonText || 'Reset' }}
            </button>

            <!-- Submit Button -->
            <button 
              type="submit" 
              class="btn btn-primary"
              [disabled]="(form.invalid && submitted) || loading">
              
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
              <i *ngIf="!loading" class="fas fa-save me-2"></i>
              {{ config.submitButtonText || 'Submit' }}
            </button>
          </div>
        </div>
      </div>
    </form>

    <!-- No Configuration Error -->
    <div *ngIf="!config && !loading" class="alert alert-warning">
      <i class="fas fa-exclamation-triangle me-2"></i>
      No form configuration provided. Please provide a valid FormConfig.
    </div>
  </div>
</div>
