<div class="card card-p-1 card-flush">
  <!-- Header -->
  <div class="card-header align-items-center py-5 gap-2 gap-md-5">
    <div class="card-title">
      <!-- Search -->
      <div
        class="d-flex align-items-center position-relative my-1"
        *ngIf="config.showSearch"
      >
        <span class="svg-icon fs-1 position-absolute ms-4">
          <i class="ki-duotone ki-magnifier fs-3">
            <span class="path1"></span>
            <span class="path2"></span>
          </i>
        </span>
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearch()"
          class="form-control form-control-solid w-250px ps-14"
          [placeholder]="config.searchPlaceholder"
        />
      </div>
    </div>

    <div class="card-toolbar flex-row-fluid justify-content-end gap-5">
      <!-- Custom Buttons -->
      <button
        *ngFor="let button of config.customButtons"
        type="button"
        [class]="'btn ' + (button.class || 'btn-light-primary')"
        (click)="onActionClick(button, {})"
      >
        <i *ngIf="button.icon" [class]="button.icon + ' fs-2'">
          <span class="path1"></span>
          <span class="path2"></span>
        </i>
        {{ button.label }}
      </button>

      <!-- Export Dropdown -->
      <div class="position-relative" *ngIf="config.showExport">
        <button
          type="button"
          class="btn btn-light-primary"
          (click)="toggleExportMenu()"
        >
          <i class="ki-duotone ki-exit-down fs-2">
            <span class="path1"></span>
            <span class="path2"></span>
          </i>
          Export Report
        </button>

        <!-- Export Menu -->
        <div
          class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-200px py-4 position-absolute top-100 end-0 z-3"
          [class.d-block]="showExportMenu"
          [class.d-none]="!showExportMenu"
          style="box-shadow: 0px 0px 50px 0px rgba(82, 63, 105, 0.15)"
        >
          <div
            *ngFor="let option of config.exportOptions"
            class="menu-item px-3"
          >
            <a
              href="#"
              class="menu-link px-3"
              (click)="onExport(option.type); $event.preventDefault()"
            >
              <i *ngIf="option.icon" [class]="option.icon + ' me-2'"></i>
              {{ option.label }}
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Table Body -->
  <div class="card-body">
    <div class="table-responsive">
      <table
        class="table align-middle border rounded table-row-dashed fs-6 g-5"
      >
        <!-- Table Header -->
        <thead>
          <tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase">
            <th
              *ngFor="let column of columns"
              [class]="
                'min-w-100px ' +
                (column.align === 'right'
                  ? 'text-end'
                  : column.align === 'center'
                  ? 'text-center'
                  : '')
              "
              [style.width]="column.width"
              [style.cursor]="column.sortable ? 'pointer' : 'default'"
              (click)="onSort(column)"
            >
              <div class="d-flex align-items-center">
                <span>{{ column.title }}</span>
                <span
                  *ngIf="column.sortable && sortColumn === column.key"
                  class="ms-2"
                >
                  <i
                    *ngIf="sortDirection === 'asc'"
                    class="ki-duotone ki-up fs-5"
                  ></i>
                  <i
                    *ngIf="sortDirection === 'desc'"
                    class="ki-duotone ki-down fs-5"
                  ></i>
                </span>
              </div>
            </th>
            <th *ngIf="actions.length > 0" class="text-end min-w-100px">
              Actions
            </th>
          </tr>
        </thead>

        <!-- Table Body -->
        <tbody class="fw-semibold text-gray-600">
          <tr
            *ngFor="let row of paginatedData"
            class="cursor-pointer"
            (click)="onRowClick(row)"
          >
            <td
              *ngFor="let column of columns"
              [ngClass]="getColumnClass(column)"
            >
              <!-- Text/Default -->
              <span *ngIf="column.type === 'text' || !column.type">
                {{ getColumnValue(row, column) }}
              </span>

              <!-- Email -->
              <a
                *ngIf="column.type === 'email'"
                [href]="'mailto:' + getNestedValue(row, column.key)"
                class="text-gray-900 text-hover-primary"
                (click)="$event.stopPropagation()"
              >
                {{ formatCellValue(row, column) }}
              </a>

              <!-- Link -->
              <a
                *ngIf="column.type === 'link'"
                [href]="getNestedValue(row, column.key)"
                class="text-gray-900 text-hover-primary"
                (click)="$event.stopPropagation()"
              >
                {{ formatCellValue(row, column) }}
              </a>

              <!-- Badge -->
              <div
                *ngIf="column.type === 'badge'"
                [class]="'badge ' + getBadgeClass(row, column)"
              >
                {{ formatCellValue(row, column) }}
              </div>

              <!-- Currency -->
              <span
                *ngIf="column.type === 'currency'"
                class="fw-bold text-gray-800"
              >
                {{ formatCellValue(row, column) }}
              </span>

              <!-- Number -->
              <span *ngIf="column.type === 'number'" class="fw-bold">
                {{ formatCellValue(row, column) }}
              </span>

              <!-- Date -->
              <span *ngIf="column.type === 'date'">
                {{ formatCellValue(row, column) }}
              </span>

              <!-- Custom template placeholder - will be handled by parent component -->
              <ng-container *ngIf="column.type === 'custom'">
                <ng-content
                  select="[slot='custom-cell-' + column.key]"
                ></ng-content>
              </ng-container>
            </td>

            <!-- Actions Column -->
            <td *ngIf="actions.length > 0" class="text-end">
              <div class="d-flex justify-content-end gap-2">
                <ng-container *ngFor="let action of actions">
                    <button
                    *ngIf="isActionVisible(action, row)"
                    type="button"
                    [class]="
                      'btn btn-icon btn-sm rounded-circle shadow-sm ' +
                      (action.class || 'btn-light-primary')
                    "
                    (click)="onActionClick(action, row); $event.stopPropagation()"
                    [title]="action.label"
                    style="transition: box-shadow 0.2s; margin-left: 2px;"
                    >
                    <span class="d-flex align-items-center justify-content-center">
                      <i *ngIf="action.icon" [class]="action.icon + ' fs-4 text-primary'">
                      <span class="path1"></span>
                      <span class="path2"></span>
                      <span class="path3"></span>
                      <span class="path4"></span>
                      <span class="path5"></span>
                      </i>
                      <span *ngIf="!action.icon" class="fw-semibold text-primary">{{ action.label }}</span>
                    </span>
                    </button>
                </ng-container>
              </div>
            </td>
          </tr>

          <!-- No Data Row -->
          <tr *ngIf="paginatedData.length === 0">
            <td
              [attr.colspan]="columns.length + (actions.length > 0 ? 1 : 0)"
              class="text-center py-5"
            >
              <div class="text-muted">No data available</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div
      *ngIf="config.showPagination && totalPages > 1"
      class="d-flex align-items-center justify-content-between mt-5"
    >
      <div class="text-muted">
        Showing {{ (currentPage - 1) * pageSize + 1 }} to
        {{ Math.min(currentPage * pageSize, filteredData.length) }} of
        {{ filteredData.length }} entries
      </div>

      <nav>
        <ul class="pagination pagination-sm">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a
              class="page-link"
              (click)="onPageChange(currentPage - 1)"
              style="cursor: pointer"
            >
              <i class="previous"></i>
            </a>
          </li>

          <li
            *ngFor="let page of [].constructor(totalPages); let i = index"
            class="page-item"
            [class.active]="currentPage === i + 1"
          >
            <a
              class="page-link"
              (click)="onPageChange(i + 1)"
              style="cursor: pointer"
            >
              {{ i + 1 }}
            </a>
          </li>

          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a
              class="page-link"
              (click)="onPageChange(currentPage + 1)"
              style="cursor: pointer"
            >
              <i class="next"></i>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Click outside to close export menu -->
<div
  *ngIf="showExportMenu"
  class="position-fixed top-0 start-0 w-100 h-100"
  style="z-index: 1"
  (click)="showExportMenu = false"
></div>
